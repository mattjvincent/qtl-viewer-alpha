{% extends "layout.html" %}

{% block head %}

    <link rel="stylesheet" href="{{request.URL_BASE}}/static/jquery.tablesorter/css/theme.bootstrap.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/jquery.tablesorter/addons/pager/jquery.tablesorter.pager.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-slider/css/bootstrap-slider.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/bootstrap-multiselect/css/bootstrap-multiselect.css">
    <link rel="stylesheet" href="{{request.URL_BASE}}/static/css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>

{% endblock %}

{% block content %}
    <!-- START FIRST ROW //-->
    <div class="row row-eq-height">
        <div class="col-xs-6 margin-bottom-30">
            <!-- START MATRIX PLOT //-->
            <div class="portlet" style="height:600px">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="glyphicon glyphicon-cog"></i>
                        <span class="caption-subject bold font-yellow-crusta uppercase">{{ g.WWW.HEADER_MATRIX }}</span>
                        <span class="caption-helper"></span>
                    </div>
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#portlet_tab_matrix" data-toggle="tab">Data Matrix</a>
                        </li>
                        <li>
                            <a href="#portlet_tab_list" data-toggle="tab">Data List</a>
                        </li>
                    </ul>
                </div>
                <div class="portlet-body">
                    <div class="row" style="padding-bottom:10px">
                        <div class="col-xs-5">
                            <strong>LOD Score Threshold:</strong> <span id="currentLodScore">{{ lod_threshold }}</span>
                        </div>
                        <div class="col-xs-7">
                            <b>{{ g.WWW.LOD_THRESHOLD_MIN }}</b> <input id="lodSlider" type="text"/> <b>{{ g.WWW.LOD_THRESHOLD_MAX }}</b>
                        </div>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane active" id="portlet_tab_matrix">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="plotMatrix" width="450" height="450"></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="portlet_tab_list">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="dataMatrix" style="height:450px;overflow-y:auto;overflow-x:hidden;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END MATRIX PLOT //-->
        </div>
        <div class="col-xs-6 margin-bottom-30">
            <!-- START SEARCH //-->
            <div class="portlet" style="height:600px">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="glyphicon glyphicon-search"></i>
                        <span class="caption-subject bold font-yellow-crusta uppercase">Gene Search</span>
                        <span class="caption-helper"></span>
                    </div>
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#portlet_tab1" data-toggle="tab">Gene Search</a>
                        </li>
                        <li>
                            <a href="#portlet_tab2" data-toggle="tab">History</a>
                        </li>
                    </ul>
                </div>
                <div class="portlet-body">
                    <div class="tab-content">
                        <div class="tab-pane active" id="portlet_tab1">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div class="input-group">
                                        <input type="text" id="searchTerm" class="form-control input-circle-left" placeholder="Example: Kit, Ren1"  value="{{ search_term }}">
                                        <span class="input-group-btn">
                                            <button id="btnGo" class="btn btn-circle-right btn-default" data-loading-text="<i class='fa fa-spinner fa-spin'></i>" type="submit">Find</button>
                                        </span>
                                    </div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-xs-12" id="searchResultsStatus"></div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="searchResults" style="height:420px;overflow-y:auto;overflow-x:hidden;"></div>
                                </div>
                            </div>
                            <!--
                            <div class="row">
                                <div class="col-xs-12">
                                    <label class="checkbox" for="checkboxShow"><input type="checkbox" value="" id="checkboxShow" data-toggle="checkbox"> Show ONLY the results</label></td><td colspan=2>
                                    <label class="checkbox" for="checkboxHighlight"><input type="checkbox" value="" id="checkboxHighlight" data-toggle="checkbox">Highlight the results</label>
                                </div>
                            </div>
                            //-->
                        </div>
                        <div class="tab-pane" id="portlet_tab2">
                            <div class="row">
                                <div class="col-xs-12" id="searchHistoryStatus"></div>
                            </div>
                            <div class="row">
                                 <div id="gene_history_div" style="height:480px;overflow-y:auto;overflow-x:hidden;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END SEARCH //-->
        </div>
    </div>
    <!-- END FIRST ROW //-->
    <!-- START SECOND ROW //-->
    <div class="row row-eq-height">
        <div class="col-xs-6 margin-bottom-30">
            <!-- START LOD PLOT //-->
            <div class="portlet">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-area-chart"></i>
                        <span class="caption-subject bold font-yellow-crusta uppercase">LOD Score Plot</span>
                        <span id="geneInformation" class="caption-helper"></span>
                    </div>
                    <!--
                    <div class="actions">
                        <a id="downloadLODPlot" data-toggle="tooltip" title="Download Plot" href="#" class="btn btn-red btn-circle">
                            <i class="glyphicon glyphicon-download-alt"></i>
                        </a>
                    </div>
                    //-->
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div id="plotLod" width="450" height="225"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END LOD PLOT //-->
        </div>
        <div class="col-xs-6 margin-bottom-30">
            <!-- START EFFECT PLOT //-->
            <div class="portlet">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-line-chart"></i>
                        <span class="caption-subject bold font-yellow-crusta uppercase">Effect Plot</span>
                        <span class="caption-helper"></span>
                    </div>
                    <!--
                    <div class="actions">
                        <a id="downloadEffectPlot" data-toggle="tooltip" title="Download Plot" href="#" class="btn btn-red btn-circle">
                            <i class="glyphicon glyphicon-download-alt"></i>
                        </a>
                    </div>
                    //-->
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div id="plotEffect" width="450" height="225"></div>
                    </div>
                </div>
            </div>
            <!-- END EFFECT PLOT //-->
        </div>
    </div>
    <!-- END SECOND ROW //-->
    <!-- START THIRD ROW //-->
    <div class="row row-eq-height">
        <div class="col-xs-6 margin-bottom-30">
            <div class="portlet">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-cogs"></i>
                        <span class="caption-subject bold font-yellow-crusta uppercase">Factorial Viewer</span>
                        <span id="_information" class="caption-helper"></span>
                    </div>
                    <!--
                    <div class="actions">
                        <a id="settingsFactSVG" data-toggle="tooltip" title="Configure Plot" href="#" class="btn btn-purple btn-circle">
                            <i class="fa fa-database"></i>
                        </a>
                    </div>
                    //-->
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <div id="fact-svg-panel">
                                <svg id="fact-svg-chart" width="450px" height="450px"></svg>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-4">
                            <strong>Factor Order</strong>
                        </div>
                    </div>
                    <div class="row" style="padding-bottom: 10px">
                        <div class="col-xs-12">
                            <span class="text-muted"><small><em>Please select the order you would like the factors to be displayed</em></small></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-10">
                            <div id="factor-select-wrapper">
                            <select id="factor-select" multiple="multiple">
                                <option value="Sex" selected order="1">Sex</option>
                                <option value="Age" selected order="2">Age</option>
                                <option value="Generation" order="3">Generation</option>
                            </select>
                            </div>
                        </div>
                        <div class="col-xs-2">
                            <button id="btnFactPlot" type="button" class="btn btn-primary">Plot</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- /.container -->
{% endblock %}

{% block javascript %}
<script src="{{request.URL_BASE}}/static/js/jquery-2.0.3.min.js"></script>
<script src="{{request.URL_BASE}}/static/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="{{request.URL_BASE}}/static/bootstrap-slider/bootstrap-slider.min.js"></script>
<script src="{{request.URL_BASE}}/static/jquery.tablesorter/js/jquery.tablesorter.min.js"></script>
<script src="{{request.URL_BASE}}/static/jquery.tablesorter/js/jquery.tablesorter.widgets.js"></script>
<script src="{{request.URL_BASE}}/static/jquery.tablesorter/addons/pager/jquery.tablesorter.pager.min.js"></script>
<script src="{{request.URL_BASE}}/static/js/d3.v3.js"></script>
<script src="{{request.URL_BASE}}/static/js/js.cookie.js"></script>
<script src="{{request.URL_BASE}}/static/js/factexpviewer.js"></script>
<script src="{{request.URL_BASE}}/static/bootstrap-multiselect/js/bootstrap-multiselect.js"></script>
<script src="{{request.URL_BASE}}/static/js/Sortable.js"></script>

<script>
///////////////////////////////////////////////////////////////////////////////
var _settings = {
    chromosomeDataFile: '/api/chromosomes',

    MATRIX: {feature_id: 'feature_id',
             feature_group_id: 'feature_group_id',
             feature_chrom: 'feature_chrom',
             feature_location: 'feature_location',
             feature_name: 'feature_name',
             marker_chrom: 'marker_chrom',
             marker_location: 'marker_location',
             lod_score: 'lod_score'
    }
};

var _defaults = {
    margin : {top : 20, right : 15, bottom : 35, left : 45}
};

var chromosomes = {};
var chromosomePosStart = [];
var chromosomePosMid = [];

var orderedDataset = {};

var plots = {};
plots.matrix = {};
plots.lod = {};
plots.effect = {};
plots.fact = {};

var _G = {};
_G.lod = {{ lod_threshold }};
_G.dataset = '{{ dataset }}';
_G.currentGene = null;

/**
 *  Utility method to get text dimensions.
**/
function measureText(svgContainer, text, classname) {
    if (!text || text.length === 0) return { height: 0, width: 0 };
    var container = svgContainer.append('g').attr('id', '_measure');
    container.append('text').attr({ x: -1000, y: -1000, class: classname}).text(text);
    var bbox = container.node().getBBox();
    container.remove();
    return { height: bbox.height, width: bbox.width};
}

function cookiesEnabled() {
    var isValid = Cookies.set('checkme', 'valid', {expires: 1}) && Cookies.get('checkme') === 'valid';
    Cookies.remove('checkme');
    return isValid;
}


/**
 *  Using jQuery .ajax method due to it's ability to do synchronous calls instead of
 *  asynchronous, we need to make sure the chromosome data is loaded efore we move on.
**/
function loadChromosomeData(dataFile) {
    var ok = false;
    chromosomes.totalLength = 0;
    chromosomes.names = [];

    $.ajax({
        url: dataFile,
        type: 'GET',
        cache: true,
        dataType: 'json',
        async: false, // don't go on if we can't load chromosome data
        beforeSend: function() { updateStatus('Attempting to download: ' + dataFile); },
        complete: function(){ updateStatus('Succesful download!'); },
        success: function (jsonData) {
            updateStatus('Successfully downloaded ' + dataFile);
            chromosomes.data = jsonData.chromosomes;
            $.each(jsonData.chromosomes, function(index, element, array) {
                chromosomePosStart.push(chromosomes.totalLength);
                chromosomes.names.push(element.name);
                chromosomes.data[index].totalStart = chromosomes.totalLength;
                chromosomes.totalLength += element.length;
             });
             chromosomePosStart.push(chromosomes.totalLength);
             ok = true;
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            console.error("Chromosome download error :" + XMLHttpRequest.responseText);
            console.error(errorThrown);
        }
    });

    chromosomePosStart.forEach(function (t, idx) {
        if (idx < chromosomePosStart.length - 1) {
            chromosomePosMid.push((t + chromosomePosStart[idx + 1]) / 2);
        }
    });

    return ok;
}

function bpToChrMBP(bp) {
    var chr = null;
    var pos = NaN;
    $.each(chromosomes.data, function(index, element, array) {
        if (element.totalStart <= bp) {
            chr = element.name;
            pos = bp - element.totalStart;
            return;
        }
    });
    return {'chr':chr, 'bp':pos};
}

function chrMBPToTotalBP (chr, Mbp) {
  return chromosomes.data[chr].totalStart + Math.round(Mbp * 1000000);
}

function downloadEffectData(gene) {
    plots.effect.data = null;
    d3.tsv("{{request.URL_BASE}}/api/effect/" + _G.dataset + "/" + gene, function (error, data) {
        if (error == null) {
            plots.effect.data = data;
            //console.log(plots.lod.maxLod);
            plotPlotEffect(plots.lod.maxLod['chrom']);

        } else {
            plots.effect.data = null;
        }
    });
}


function highlightGene(gene) {
    var found = plots.matrix.svg.select('#circ_' + gene);
    found.classed("highlight", !found.classed("highlight"));

    plots.matrix.svg.append("circle")
        .attr("cx", found.attr('cx'))
        .attr("cy", found.attr('cy'))
        .attr("r", 10)
        .style("stroke", 'red')
        .style("stroke-opacity", 1)
        .style("fill", "none")
        .transition()
        .duration(750)
        .ease(Math.sqrt)
        .attr("r", 1e-6)
        .style("stroke-opacity", 1e-6)
        .remove();

}


function showFoundGenes() {
    if (plots.matrix.found.length != 0) {
        if ($('#checkboxShow').is(':checked')) {
            // hide all
            plots.matrix.chartBody.selectAll("circle").attr('r', 0);

            // show found
            for (e in plots.matrix.found) {
                var gene = plots.matrix.found[e];
                var found = plots.matrix.svg.select('#circ_' + gene);
                found.attr('r', 2);
            }

        } else {
            // show all
            plots.matrix.chartBody.selectAll("circle").attr('r', 2);
        }
    }
}

function highlightFoundGenes() {
    if (plots.matrix.found.length != 0) {
        for (e in plots.matrix.found) {
            var gene = plots.matrix.found[e];
            var found = plots.matrix.svg.select('#circ_' + gene);
            found.classed("highlight", $('#checkboxHighlight').is(':checked'));
            plots.matrix.svg.append("circle")
                .attr("cx", found.attr('cx'))
                .attr("cy", found.attr('cy'))
                .attr("r", 10)
                .style("stroke", 'red')
                .style("stroke-opacity", 1)
                .style("fill", "none")
                .transition()
                .duration(750)
                .ease(Math.sqrt)
                .attr("r", 1e-6)
                .style("stroke-opacity", 1e-6)
                .remove();
        }
    }
}

function zoomToGene(gene) {
    var found = plots.matrix.svg.select('#circ_' + gene);
    var cx = found.attr('cx');
    var cy = found.attr('cy');
    var scaleFactor = 10;
    plots.matrix.zoom.scale(scaleFactor);
    cx = (cx * -scaleFactor) + plots.matrix.width/2;
    cy = (cy * -scaleFactor) + plots.matrix.height/2;

    plots.matrix.zoom.translate([cx, cy]);
    zoomed();
}


function findGene() {
    findGene(false);
}

function findGene(do_plot) {
    $("#btnGo").button('loading');
    var searchTerm = $('#searchTerm').val().trim().toUpperCase();
    $('#searchResultsStatus').html("");
    $('#searchResults').html("");

    if (searchTerm.length == 0) {
        // can't search on nothing
        //$('#searchResultsStatus').html("Zoinks! Unable to search for nothing.");
        $('#searchTerm').focus();
        $("#btnGo").button('reset');
        return;
    }


    plots.matrix.filteredData = [];
    plots.matrix.found = [];

    searchResults = {};


    var url = "{{request.URL_BASE}}/api/search?exact=False&species=Mm&term=" + searchTerm;

    var jqxhr = $.getJSON(url).done(function( data, textStatus, jqXHR ) {
               if (data.error) {
                   $('#searchResultsStatus').html("<br><span class='text-danger'>Error searching.</span>");
               }

               if (data.result.matches.length <= 0) {
                   $('#searchResultsStatus').html("<br><span class='text-danger'>No results found.</span>");
               } else {
                   if (data.result.matches.length == 1) {
                       $('#searchResultsStatus').html("<p class='text-right text-muted'><em><small>" + data.result.matches.length.toLocaleString() + " result</small></em></p>");
                   } else {
                       $('#searchResultsStatus').html("<p class='text-right text-muted'><em><small>" + data.result.matches.length.toLocaleString() + " results</small></em></p>");
                   }

                    var tbl = '<table id="searchTable" class="table-condensed">';
                    tbl += '<thead><tr><th>Ensembl ID</th><th>Symbol</th><th>LOD Score</th></tr></thead>';
                    tbl += '<tbody>';

                    for (d in data.result.matches) {

                        var delem =data.result.matches[d];

                        //console.log(delem);
                        var row = '<tr>';
                        searchResults[delem.ensembl_id] = delem;

                        if (delem.ensembl_id in plots.matrix.ids) {
                            // we know a point exists, find it
                            var found = plots.matrix.svg.select('#circ_' + delem.ensembl_id)[0][0];
                            if (found) {
                                var _data = found.__data__;
                                row += '<td><a href="#" id="plotMe" gene_id="' + delem.ensembl_id + '" geneSymbol="' + _data[_settings.MATRIX.feature_name] + '" ensId="' + delem.ensembl_id + '">' + delem.ensembl_id + '</a> <a href="#" gene_id="' + _data[_settings.MATRIX.feature_name] + '" ensId="' + delem.ensembl_id + '"></a><span id="matchInfo" ensId="' + delem.ensembl_id + '" class="glyphicon glyphicon-info-sign"></span></a></td>';
                                row += ('<td>' + _data[_settings.MATRIX.feature_name] + '</td>');
                                row += ('<td>' + Number(_data[_settings.MATRIX.lod_score]).toFixed(4) + '</td></tr>');

                                plots.matrix.found.push(delem.feature_id);
                                plots.matrix.filteredData.push(delem);

                            } else {
                                row += '<td>' + delem.ensembl_id + ' <span id="matchInfo" ensId="' + delem.ensembl_id + '" class="glyphicon glyphicon-info-sign"></span></td>';
                                row += ('<td>' + delem.symbol + '</td>');
                                row += ('<td></td></tr>');
                            }
                        } else {
                                row += '<td>' + delem.ensembl_id + ' <span id="matchInfo" ensId="' + delem.ensembl_id + '" class="glyphicon glyphicon-info-sign"></span></td>';
                                row += ('<td>' + delem.symbol + '</td>');
                                row += ('<td></td></tr>');
                        }
                        row += '</tr>';
                        tbl += row;



                        if(plots.matrix.found.length >= 100) {
                            break;
                        }
                    }

                    tbl += "</tbody>";
                    tbl += "</table>";
                    $('#searchResults').html(tbl);

                    $("#searchTable").tablesorter({
                        theme: "bootstrap",
                        widthFixed: true,
                        headerTemplate: '{content} {icon}', // new in v2.7. Needed to add the bootstrap icon!
                        widgets: ["uitheme", "zebra"],
                        widgetOptions: {
                            zebra: ["even", "odd"]
                        }
                    });

                    $("a[id='plotMe']").click(function (e) {
                        //console.log($(this).attr('ensId'));
                        e.preventDefault();
                        $("#geneInformation").html("<b>Gene</b>: " + "<a target='_newwin' href='http://www.informatics.jax.org/marker/" + $(this).attr('ensId') + "'>" + $(this).attr('geneSymbol') + '</a> (' + $(this).attr('ensId') + ')');


                       // highlightGene($(this).attr('ensId'));
                        downloadLodData($(this).attr('gene_id'));
                        return false;
                    });


                    to = setTimeout(function () {
                        $("[id='matchInfo']").each(function () {
                            var that = $(this);

                            $(this).popover({
                                placement: 'left',
                                html: true,
                                trigger: 'hover',
                                container: 'body',
                                template:'<div class="popover container my-custom-class" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                                content: function () {
                                    var d = searchResults[that[0].getAttribute("ensid")];
                                    var h = '<table class="table table-condensed">';
                                    h += '<tr><td><strong>Symbol</strong> </td><td>' + d['symbol'] + '</td></tr>';
                                    h += '<tr><td><strong>Location</strong> </td><td>' + d['chromosome'] + ':' + d['position_start'] + '-' + d['position_end'] + '</td></tr>';
                                    h += '<tr><td><strong>Name</strong> </td><td>' + d['name'] + '</td></tr>';
                                    h += '<tr><td><strong>Synonyms</strong> </td><td>';

                                    var s = d['synonyms'];
                                    if (s) {
                                        if (s.length > 5) {
                                            var s2 = s.slice(1, 6);
                                            h += s2.join("<br>");
                                            h += "<br><i>(" + (s.length - s2.length) + " more synonyms)</i>";
                                        } else {
                                            h += s.join("<br>");
                                        }
                                    }
                                    h += '</td></tr>';
                                    h += '<tr><td><strong>Match Reason</strong> </td><td>' + d['match_reason'] + '</td></tr>';
                                    h += '<tr><td><strong>Match Value</strong> </td><td>' + d['match_value'] + '</td></tr>';
                                    h += '</table>';

                                    return h;
                                }
                            });
                        });
                    });
               }

               // added for search_term to be passed in from url ?search_term=<something>
               if (do_plot) {
                   console.log(Object.keys(searchResults).length);
                   if (Object.keys(searchResults).length == 1) {
                       var d = plots.matrix.filteredData[0];
                       var found = plots.matrix.svg.select('#circ_' + d.ensembl_id)[0][0];
                       if (found) {
                           console.log('found');
                           console.log(d.ensembl_id);
                           $("#geneInformation").html("<b>Gene</b>: " + "<a target='_newwin' href='http://www.informatics.jax.org/marker/" + d.ensembl_id + "'>" + d.symbol + '</a> (' + d.ensembl_id + ')');
                           downloadLodData(d.ensembl_id);
                       } else {
                           console.log('NOT FOUND');
                       }

                   }
               }


            }).fail(function( jqXHR, textStatus, errorThrown ) {
                // fail is for network error or similar
                console.log('fail');
            }).always(function( data, textStatus, jqXHR ) {
                //jqXHR.always(function( data|jqXHR, textStatus, jqXHR|errorThrown ) { });
                // the always function 1st and 3rd params flip flop based upon there
                // was a successful ajax call or not
                console.log('always');
                $("#btnGo").button('reset');
            });
}




function buildDataListTable(data, threshold) {
    var new_data = data.filter(function(e){
        if (+e['lod_score'] >= threshold ) {
            return true;
        }
        return false;
    });

    d3.select("#tblMatrix").remove();


    function tabulate(data, columns) {
        var table = d3.select("#dataMatrix")
                        .append("table")
                        .attr("class", "table-condensed tablesorter tablesorter-bootstrap table table-bordered")
                        .attr("id", "tblMatrix");
        var thead = table.append("thead");
        var tbody = table.append("tbody");

        // append the header row
        thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                .text(function (column) {
                    if (column === 'lod_score') {
                        return 'LOD';
                    } else if (column === 'feature_name') {
                        return 'Symbol'
                    } else if (column === 'feature_id') {
                        return 'ID'
                    } else {
                        return column;
                    }
                });


        // create a row for each object in the data
        var rows = tbody.selectAll("tr")
                .data(data.sort(function(a,b) {
                    return +b[_settings.MATRIX.lod_score] - +a[_settings.MATRIX.lod_score];
                }))
                .enter().append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                    .data(function (row) {
                        return columns.map(function (column) {
                            if (column === 'lod_score') {
                                return {column: column, value: Number(row[column]).toFixed(2)};
                            } else if (column === 'feature_id') {
                                //return {column: column, value: Number(row[column]).toFixed(2)};
                                var atag = '<a href="#" id="plotMe" geneSymbol="' + row['Symbol'] + '" gene_id="' + row[column] + '" ensId="' + row[column] + '">' + row[column] + '</a></td>';
                                return {column: column, value: atag};
                            } else {
                                return {column: column, value: row[column]};
                            }
                        });
                    })
                    .enter()
                    .append("td")
                    //.attr("style", "font-family: Courier") // sets the font style
                    .html(function (d) {
                        return d.value;
                    });

            return table;
        }

// render the table
        var peopleTable = tabulate(new_data, [_settings.MATRIX.feature_id, _settings.MATRIX.feature_name, _settings.MATRIX.lod_score]);


        $("#tblMatrix a").click(function (e) {
            e.preventDefault();
            $("#geneInformation").html("<b>Gene</b>: " + "<a target='_newwin' href='http://www.informatics.jax.org/marker/" + $(this).attr('ensId') + "'>" + $(this).attr('geneSymbol') + '</a> (' + $(this).attr('ensId') + ')');
            downloadLodData($(this).attr('gene_id'));
            return false;
        });



                    $("#tblMatrix").tablesorter({
                        theme: "bootstrap",
                        widthFixed: true,
                        headerTemplate: '{content} {icon}', // new in v2.7. Needed to add the bootstrap icon!
                        widgets: ["uitheme", "zebra"],
                        widgetOptions: {
                            zebra: ["even", "odd"]
                        }
                    });

}

function plotPlotMatrix() {








    updateStatus('Loading QTL data...');
    console.log('Loading QTL data...');
    plots.matrix.ids = {};



    d3.tsv('{{request.URL_BASE}}/api/matrix')
        .on("progress", function() {
          updateStatus('Downloaded: ' + d3.event.loaded + ' bytes');
          console.log('Downloaded: ' + d3.event.loaded + ' bytes');
        })
        .on("beforesend", function() { console.log("beforesend!"); })
        .on("load", function() { console.log("success!"); })
        .on("error", function() { console.log("failure!"); })
        .get(function(error, data) {
            updateStatus('');
            if (error == null) {
                plots.matrix.data = data.filter(function(e){
                    if ($.inArray(e[_settings.MATRIX.feature_chrom], chromosomes.names) > -1) {
                        /*
                        console.log('Ensembl ID:' + e[_settings.MATRIX.ensembl_id]);
                        console.log('Gene Symbol:' + e[_settings.MATRIX.gene_symbol]);
                        console.log('Gene Chr:' + e[_settings.MATRIX.gene_chr]);
                        console.log('Gene Pos:' + e[_settings.MATRIX.gene_pos]);
                        console.log('RS Chr:' + e[_settings.MATRIX.rs_chr]);
                        console.log('RS Pos:' + e[_settings.MATRIX.rs_pos]);
                        console.log('LOD Score:' + e[_settings.MATRIX.lod_score]);
                        */
                        return true;
                    }
                    return false;
                });

                //var to = setTimeout(function() {
                    console.log('Plotting...');

                     plots.matrix.chartBodyCircles = plots.matrix.chartBody.selectAll("circle")
                        .data(plots.matrix.data)
                        .enter()
                        .append("circle")
                        .attr('id', function (d) {
                            plots.matrix.ids[d[_settings.MATRIX.feature_id]] = d;
                            return 'circ_' + d[_settings.MATRIX.feature_id];
                        })
                        .attr("class", "dot")
                        .attr("cx", function (d) {
                            return plots.matrix.x(chrMBPToTotalBP(d[_settings.MATRIX.marker_chrom], d[_settings.MATRIX.marker_location]));
                        })
                        .attr("cy", function (d) {
                            return plots.matrix.y(chrMBPToTotalBP(d[_settings.MATRIX.feature_chrom], d[_settings.MATRIX.feature_location]));
                        })
                        .attr("r", 2)
                        .style("opacity", function (d) {
                            var s = parseFloat(d[_settings.MATRIX.lod_score]);
                            if (s > 20) { return 1; }
                            else { return s * 5 / 100; }
                        })
                        .on("mouseover", function (d) {
                            d3.selectAll('#circ_' + d[_settings.MATRIX.feature_id]).attr("r", 4).style("fill", "red").style("opacity", 1.0);
                        })
                        .on("mouseout", function (d) {
                            d3.selectAll('#circ_' + d[_settings.MATRIX.feature_id]).attr("r", 2).style("opacity", function (d) {
                                var s = parseFloat(d[_settings.MATRIX.lod_score]);
                                if (s > 20) { return 1; }
                                else { return s * 5 / 100; }
                            }).style("fill", "black");
                        })
                        .on("click", function (d) {
                            $("#geneInformation").html("<b>Gene</b>: " + "<a target='_newwin' href='http://www.informatics.jax.org/marker/" +  d[_settings.MATRIX.feature_id] + "'>" + d[_settings.MATRIX.feature_name] + '</a> (' + d[_settings.MATRIX.feature_id] + ')');
                            downloadLodData(d[_settings.MATRIX.feature_id]);
                        });




                   buildDataListTable(plots.matrix.data, _G.lod);







                    console.log('Done Plotting...');
                //});
                //console.profileEnd();

                try {
                    console.log("making tool tips...");

                   // to = setTimeout(function () {
                        $('#' + plots.matrix.id + ' circle').each(function () {
                            //console.log(this);
                            $(this).popover({
                                placement: 'top',
                                html: true,
                                trigger: 'hover',
                                container: 'body',
                                template:'<div class="popover container my-custom-class" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                                content: function () {
                                    var d = this.__data__;
                                    var h = "";
                                    h += '<table class="table table-condensed">';
                                    h += '<tr><td><strong>Gene Symbol</strong></td><td>' + d[_settings.MATRIX.feature_name] + '</td></tr>'
                                    h += '<tr><td><strong>Gene ID</strong></td><td>' + d[_settings.MATRIX.feature_id] + '</td></tr>'
                                    h += '<tr><td><strong>LOD Score</strong></td><td>' + Number(d[_settings.MATRIX.lod_score]).toFixed(2) + '</td></tr>'
                                    h += '<tr><td><strong>Marker Position</strong></td><td>' + d[_settings.MATRIX.marker_chrom] + ":" + d[_settings.MATRIX.marker_location] + '</td></tr>'
                                    h += '<tr><td><strong>Gene Position</strong></td><td>' + d[_settings.MATRIX.feature_chrom] + ":" + d[_settings.MATRIX.feature_location] + '</td></tr>'
                                    h += '</table>';
                                    return h;
                                }
                            });
                        });
                    //});
                    console.log("DONE making tool tips");
                } catch(err) {
                    console.log(err.message);
                }


                applyLODThreshold({{ lod_threshold }});
                console.log('Finding gene now...');
                {% if search_term %}
                findGene(true);
                {% endif %}


            } else {
                updateStatus(error);
            }

        });

}

function updateStatus(txt) {
    if (txt === '') {
        $("#status").html('');
    }
    else {
        $("#status").html('Status: ' + txt);
    }

}

function arraymove(arr, fromIndex, toIndex) {
    console.log('moving from', fromIndex, 'to', toIndex);
    var element = arr[fromIndex];
    arr.splice(fromIndex, 1);
    arr.splice(toIndex, 0, element);
}


/**
 * Download the LOD scores
 */

function downloadLodData(gene) {
    updateStatus('Acquiring data for ' + gene);

    // cookies, everywhere cookie
    var gene_data = Cookies.getJSON("gene_data");
    var index = -1;

    // build the history of 'clicked' genes
    if (gene_data) {
        // move to the top if already here
        for (var i in gene_data) {
            console.log('gene_data[i]=',gene_data[i]);
            if (gene_data[i]['id'] === gene) {
                index = i;
                break;
            }
        }
        if (index > 0) {
            arraymove(gene_data, index, 0);
        } else if (index == -1) {
            console.log('plots.matrix.ids[gene]=',plots.matrix.ids[gene]);
            var gene_info = {'id': gene, 'sym': plots.matrix.ids[gene]['feature_name'], 'lod': plots.matrix.ids[gene]['lod_score']}
            gene_data.unshift(gene_info);


            if (gene_data.length > 25) {
                gene_data.pop();
            }


        } else {
            console.log('doing nothing, returning');
        }
    } else {
        var gene_info = {'id': gene, 'sym': plots.matrix.ids[gene]['feature_name'], 'lod': plots.matrix.ids[gene]['lod_score']}
        gene_data = [gene_info];
    }

    // attempt to set the cookie, if there is to much data the cookie won't set, so we need to check and adjust the array size
/*
    var done = false;
    var i = 1;

    while (!done) {
        console.log('pass ', i);
        var current_gene_data = Cookies.getJSON("gene_data");
        Cookies.set("gene_data", gene_data);
        var new_gene_data = Cookies.getJSON("gene_data");

        if (new_gene_data != current_gene_data) {
            // if they aren't equal,
            console.log('not equal')
            done = true;
            continue;
        }

        // remove the last element
        console.log('data too big, popping an element off the array');
        gene_data.pop();
        i++;
    }

*/
    Cookies.set("gene_data", gene_data);


     _G.currentGene = gene;

    buildHistory();

    d3.tsv('{{request.URL_BASE}}/api/lod/' + _G.dataset + '/' + gene, function (error, data) {
        updateStatus(error);
        if (error == null) {
            plotPlotLod(data);
            downloadEffectData(gene);
            updateStatus('');
        } else {
            console.log('MAJOR ERROR');
            console.log(error);
        }
    });


    getFactExpViewData(gene, getFactorOrder());

}

function plotPlotLod(dataset) {

    for (var i = 0; i < chromosomes.names.length; i++) {
        orderedDataset[chromosomes.names[i]] = {};
        orderedDataset[chromosomes.names[i]].data = [];
    }

    plots.lod.maxLod = dataset[0];

    //console.log(orderedDataset);

    for (d in dataset) {
        var elem = dataset[d];
        if (parseFloat(elem['lod']) > parseFloat(plots.lod.maxLod['lod'])) {
            //console.log(elem);
            plots.lod.maxLod = elem;
        }
        //console.log('elem=', elem);
        orderedDataset[elem['chrom']].data.push(elem);
    }

    //console.log('MAX LOD=' +plots.lod.maxLod['lod']);
    //console.log(plots.lod.maxLod);

    // input domain is the min and max data values
    // output range is the min and max pixel values (screen)
    plots.lod.x = d3.scale.linear().rangeRound([0, plots.lod.width]).domain([0, chromosomes.totalLength]);
    plots.lod.y = d3.scale.linear().rangeRound([0, plots.lod.height]).domain([parseFloat(plots.lod.maxLod["lod"]) + 0.5, 0]);


    var transitionData = false;
    var yAxis = d3.svg.axis().scale(plots.lod.y).orient("left").ticks(5).tickSize(-plots.lod.width);

    if (plots.lod.groupTop == null) {
        plots.lod.groupTop = plots.lod.svg.append('g').attr('id', 'plots.lodGroupTop');
        plots.lod.groupNondata = plots.lod.groupTop.append('g').attr('id', 'plots.lodGroupNondata');
        plots.lod.groupData = plots.lod.groupTop.append('g').attr('id', 'plots.lodGroupData');
        plots.lod.groupDataChr = {};
        plots.lod.groupDataCircle = {};

    } else {
        plots.lod.groupYAxis.remove();
        transitionData = true;
    }

    for (var i = 0; i < chromosomes.names.length; i++) {
        var chr_i = chromosomes.data[chromosomes.names[i]];
        updateStatus(chromosomes.names[i]);

        if (plots.lod.groupDataChr[chromosomes.names[i]] == null) {
            plots.lod.groupDataChr[chromosomes.names[i]] = plots.lod.groupData.append("g").attr('id', 'chr' + chromosomes.names[i]);
        }

        start_bp_i = chr_i["totalStart"];
        length_bp_i = chr_i["length"];
        end_bp_i = start_bp_i + length_bp_i;
        start_sx = plots.lod.x(chrMBPToTotalBP(chr_i.name, (0 / 1000000)));
        end_sx = plots.lod.x(chrMBPToTotalBP(chr_i.name, (length_bp_i / 1000000)));
        length_sx = end_sx - start_sx;

        orderedDataset[chromosomes.names[i]].scale_x = d3.scale.linear().rangeRound([start_sx, end_sx]).domain([start_bp_i, end_bp_i]);


        var line = d3.svg.line()
            .x(function (d) {
            var val = chrMBPToTotalBP(d['chrom'], parseInt(d['location']));
            var x1 = orderedDataset[chromosomes.names[i]].scale_x(val);
            return x1;
        }).y(function (d) {
            return plots.lod.y(parseFloat(d['lod']));
        });


        if (transitionData) {
            mydata = orderedDataset[chromosomes.names[i]].data;
            plots.lod.groupDataChr[chromosomes.names[i]].select('path')
                .data(mydata)
                .transition()
                .attr("d", line(mydata))
                .ease("easeInOutElastic")
                .duration(1000);
        } else {
            plots.lod.groupNondata.append("rect")
                .attr("x", start_sx)
                .attr("y", plots.lod.y)
                .attr("id", "lod_rect_" + chromosomes.names[i])
                .attr("width", length_sx)
                .attr("height", plots.lod.height)
                .attr("class", 'checkerboard' + ((i % 2) + 1))
                .on("click", function () {
                // TODO: fix this hack
                // a sily way to get the chromosome clicked on
                var c = this.id.substr(9);
                plotPlotEffect(c);
            });


            var m = measureText(plots.lod.svg, chromosomes.names[i], "x-axis");
            plots.lod.groupNondata.append("text")
                .attr("x", start_sx + (length_sx / 2) - (m.width / 2))
                .attr("y", plots.lod.height + m.height)
                .text(chromosomes.names[i])
                .attr("class", "x-axis");

            mydata = orderedDataset[chromosomes.names[i]].data;
            plots.lod.groupDataChr[chromosomes.names[i]]
                .append("path")
                .data(mydata)
                .attr("d", line(mydata))
                .attr("stroke", "darkslateblue")
                .attr("stroke-width", 2)
                .attr("fill", "none")
                .attr('pointer-events', 'none')
                .attr("id", "myPath");
        }

        (function (i) {
            setTimeout(function () {
                var name = chromosomes.names[i];

                if (plots.lod.groupDataCircle[name] != null) {
                    plots.lod.groupDataCircle[name].remove();
                }
                plots.lod.groupDataCircle[name] = plots.lod.groupData.append('g').attr('id', 'circ' + name);

                plots.lod.groupDataCircle[name].selectAll("circle")
                    .data(orderedDataset[name].data)
                    .enter()
                    .append("circle")
                    .attr("r", 5)
                    .attr("class", "plotlod-circle")
                    .attr('id', function (d) {
                        return 'clod_' + d['marker_id'];
                    })
                    .style('fill', 'none')
                    .style('stroke', function(d) {
                        if (d['marker_id'] === plots.lod.maxLod['marker_id']) {
                            return 'red';
                        } else {
                            return 'none';
                        }
                    })
                    .style('opacity', function (d) {
                        if (d['marker_id'] === plots.lod.maxLod['marker_id']) {
                            return 1;
                        } else {
                            return .1;
                        }
                    })
                    .attr("cx", function (d) {
                        return orderedDataset[name].scale_x(chrMBPToTotalBP(d["chrom"], parseInt(d["location"])));
                    })
                    .attr("cy", function (d) {
                        return plots.lod.y(d['lod']);
                    })
                    .on("mouseover", function (d) {
                        if (d['marker_id'] != plots.lod.maxLod['marker_id']) {
                            d3.selectAll('#clod_' + d['marker_id']).attr("r", 5).style("fill", "pink").style("stroke", "blue").style("stroke-width", 1).style("opacity", 1.0);
                        }
                    })
                    .on("mouseout", function (d) {
                        if (d['marker_id'] != plots.lod.maxLod['marker_id']) {
                            var sval = 'red';
                            var opacity = 1;
                            d3.selectAll('#clod_' + d['marker_id']).attr("r", 1).style("fill", "#8C4374").style("stroke", sval).style("stroke-width", 1).style("opacity", 0.1);
                        }

                    })
                    .on("click", function (d) {
                        plotPlotEffect(d['chrom']);
                    });
            }, 1);
        })(i);

    } // end for



      to = setTimeout(function () {
            $('#' + plots.lod.id + ' circle').each(function () {
                var that = $(this);
                $(this).popover({
                    placement: 'top',
                    html: true,
                    trigger: 'hover',
                    container: 'body',
                    //template:'<div class="popover container my-custom-class" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',
                    content: function () {
                        var d = this.__data__;
                        var h = "";
                        h += '<table class="table table-condensed">';
                        h += '<tr><td><strong>ID</strong></td><td>' + d['marker_id'] + '</td></tr>'
                        h += '<tr><td><strong>Location</strong></td><td>' + Number(d['lod']).toFixed(4)  + '</td></tr>'
                        h += '</table>';
                        return h;
                    }
                });
            });
      });


    plots.lod.groupYAxis = plots.lod.groupNondata.append("g")
        .attr("id", "lodYAxis")
        .attr("class", "y-axis")
        .call(yAxis);
}



function plotPlotEffect(c) {
    if (c == undefined) {
        console.error('whoa');
    }


    if (plots.effect.groupTop == null) {
        plots.effect.groupTop = plots.effect.svg.append("g").attr('id', 'plotCoefTopGroup');
    } else {
        plots.effect.groupTop.selectAll(".strains").transition();
        plots.effect.groupTop.remove();
        plots.effect.groupTop = plots.effect.svg.append("g").attr('id', 'plotCoefTopGroup');
    }

    probeLookup = {};
    // orderedDataset[c] has the probes and their positions (to be plotted on x-axis)
    // DATA.COEF has the downloaded coef data (to be plotted on y-axis)

    // newCoef will contain only matching probeids
    var newCoef = plots.effect.data.filter(function (e) {
        var probeId = e["marker_id"];
        var match = false;
        if (c in orderedDataset) {
            for (var i = 0; i < orderedDataset[c].data.length; i++) {
                if (probeId === orderedDataset[c].data[i]['marker_id']) {
                    probeLookup[probeId] = {
                        chr: orderedDataset[c].data[i]['chrom'],
                        pos: orderedDataset[c].data[i]['location']
                    };
                    return true;
                }
            }
        }
        return false;
    });




    // get the keys of the file
    var keys = d3.keys(newCoef[0]);


    var new_keys = keys.filter(function (key) {
        return key !== "marker_id";
    });

    var strains = d3.scale.ordinal().domain(new_keys);
    var strains2 = strains.domain().map(function (name) { // name will be each of the new_keys values
        return {
            // swith this to the strain name
            name: name,
            // create an array of objects to return
            values: newCoef.map(function (d) {
                var pid = d['marker_id'];
                return {
                    probeid: pid,
                    chr: probeLookup[pid].chr,
                    pos: probeLookup[pid].pos,
                    modCoef: parseFloat(d[name])
                };
            })
        };
    });

    var width = plots.effect.width - 100;
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([plots.effect.height, 0]);

    x.domain([0, (chromosomes.data[c]["length"] / 1000000)]);

    y.domain([
        d3.min(strains2, function (c) {
            return d3.min(c.values, function (v) {
                return v.modCoef;
            });
        }),
        d3.max(strains2, function (c) {
            return d3.max(c.values, function (v) {
                return v.modCoef;
            });
        })
    ]);



    var xAxis = d3.svg.axis().scale(x).orient("bottom").tickSize(-plots.effect.height, -10, 0);

    var yAxis = d3.svg.axis().scale(y).orient("left").ticks(5).tickSize(-width, -10, 0);

    var line = d3.svg.line()
        .x(function (d) {
            return x(d.pos);
        })
        .y(function (d) {
            return y(d.modCoef);
        });

    plots.effect.groupTop.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0," + plots.effect.height + ")")
        .call(xAxis);

    plots.effect.groupTop.append("g")
        .attr("id", "effectYAxis")
        .attr("class", "y-axis")
        .call(yAxis);


    var cwhoa = plots.effect.groupTop.selectAll(".strains")
        .data(strains2)
        .enter()
        .append("g")
        .attr("class", "strains");

    cwhoa.append("path")
        .attr("d", function (d) {
            return line(d.values);
        })
        .attr('id', function (d) {
            return 'line-strain-' + d.name;
        })
        .attr("opacity", "0")
        .style("stroke-width", "0")
        .transition()
        .attr("opacity", "1")
        .style("stroke-width", "2");
    /*

    //    .style("stroke", function (d) {
    //        return plots.effect.strainColors[d.name].color;
    //    });
   */
}



function setPlotDefaults(plot) {
    for (key in _defaults) {
        plot[key] = _defaults[key];
    }
}


function initializePlotMatrix(divId) {
    setPlotDefaults(plots.matrix);
    plots.matrix.id = divId;

    plots.matrix.divWidth = parseInt($('#' + divId).attr('width'));
    plots.matrix.divHeight = parseInt($('#' + divId).attr('height'));
    plots.matrix.width = plots.matrix.divWidth - plots.matrix.margin.left - plots.matrix.margin.right;
    plots.matrix.height = plots.matrix.divHeight - plots.matrix.margin.top - plots.matrix.margin.bottom;

    plots.matrix.x = d3.scale.linear().rangeRound([0, plots.matrix.width]).domain([0, chromosomes.totalLength]);
    plots.matrix.y = d3.scale.linear().rangeRound([0, plots.matrix.height]).domain([chromosomes.totalLength, 0]);
    /*
    plots.matrix.zoom = d3.behavior.zoom()
        .x(plots.matrix.x)
        .y(plots.matrix.y)
        .scaleExtent([1, 100])
        .on("zoom", zoomed);
    */
    plots.matrix.svg = d3.select('#' + divId)
        .append("svg")
        .attr('id', divId + 'SVG')
        .attr('width', plots.matrix.width + plots.matrix.margin.left + plots.matrix.margin.right)
        .attr('height', plots.matrix.height + plots.matrix.margin.top + plots.matrix.margin.bottom)
        .append("g")
        .attr("transform", "translate(" + plots.matrix.margin.left + "," + plots.matrix.margin.top + ")")
        ;//.call(plots.matrix.zoom);
    plots.matrix.svg.append("rect")
        .attr("width", plots.matrix.width)
        .attr("height", plots.matrix.height)
        .attr("class", "plot");

    plots.matrix.make_x_axis = function () {
        return d3.svg.axis()
            .scale(plots.matrix.x)
            .orient("bottom")
            .tickValues(chromosomePosStart);
    };

    plots.matrix.make_y_axis = function () {
        return d3.svg.axis()
            .scale(plots.matrix.y)
            .orient("left")
            .tickValues(chromosomePosStart);
    };

    plots.matrix.xAxis = d3.svg.axis()
        .scale(plots.matrix.x)
        .orient("bottom")
        .tickValues(chromosomePosMid)
        .tickFormat(function(d) { return bpToChrMBP(d).chr; });

    var xTitleDim = measureText(plots.matrix.svg, "QTL Position", "x-axis-title");
    var yTitleDim = measureText(plots.matrix.svg, "Gene Position", "y-axis-title");

    plots.matrix.svg.append("text")
        .attr("y", 0 - plots.matrix.margin.top - (yTitleDim.height/2))
        .attr("x", -(plots.matrix.height/2) - (yTitleDim.width/2))
        .attr("transform", "rotate(-90)")
        .text("Gene Position")
        .attr("class", "y-axis-title");

    plots.matrix.svg.append("text")
        .attr("y", plots.matrix.height + plots.matrix.margin.bottom)
        .attr("x", (plots.matrix.width/2) - (xTitleDim.width/2))
        .text("Marker Position")
        .attr("class", "x-axis-title");

    var clipX = plots.matrix.svg.append("clipPath")
          .attr('id', 'clip-x-axis')
          .append('rect')
          .attr('x', 0)
          .attr('y', 0)
          .attr('width', plots.matrix.width)
          .attr('height', plots.matrix.margin.bottom);

    plots.matrix.svg.append("g")
        .attr("class", "x-axis")
        .attr('clip-path', 'url(#clip-x-axis)')
        .attr("transform", "translate(0, " + plots.matrix.height + ")")
        .call(plots.matrix.xAxis);

    plots.matrix.yAxis = d3.svg.axis()
        .scale(plots.matrix.y)
        .orient("left")
        .tickValues(chromosomePosMid)
        .tickFormat(function(d) { return bpToChrMBP(d).chr; });

    var clipY = plots.matrix.svg.append("clipPath")
          .attr('id', 'clip-y-axis')
          .append('rect')
          .attr('x', - plots.matrix.margin.left)
          .attr('y', 0)
          .attr('height', plots.matrix.height)
          .attr('width', plots.matrix.margin.left);

    plots.matrix.svg.append("g")
        .attr("class", "y-axis")
        .attr('clip-path', 'url(#clip-y-axis)')
        .call(plots.matrix.yAxis);


    var clip = plots.matrix.svg.append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", plots.matrix.width)
        .attr("height", plots.matrix.height);


    plots.matrix.chartBody = plots.matrix.svg.append("g")
        .attr("clip-path", "url(#clip)");

    plots.matrix.chartBody.append("g")
        .attr("class", "x-grid")
        .attr("transform", "translate(0," + plots.matrix.height + ")")
        .call(plots.matrix.make_x_axis()
        .tickSize(-plots.matrix.height, 0, 0)
        .tickValues(chromosomePosStart)
        .tickFormat(""));

    plots.matrix.chartBody.append("g")
        .attr("class", "y-grid")
        .call(plots.matrix.make_y_axis()
        .tickSize(-plots.matrix.width, 0, 0)
        .tickValues(chromosomePosStart)
        .tickFormat(""));
}


function initializePlotLod(divId) {
    setPlotDefaults(plots.lod);
    //('#panel-body-lod').
    plots.lod.id = divId;
    plots.lod.divWidth = parseInt($('#' + divId).attr('width'));
    plots.lod.divHeight = parseInt($('#' + divId).attr('height'));
    plots.lod.width = plots.lod.divWidth;// - plots.lod.margin.left;// - plots.lod.margin.right;
    plots.lod.height = plots.lod.divHeight - plots.lod.margin.top - plots.lod.margin.bottom;
    plots.lod.svg = d3.select('#' + divId)
        .append("svg")
        .attr('id', divId + 'SVG')
        .attr('width', plots.lod.width + plots.lod.margin.left + plots.lod.margin.right)
        .attr('height', plots.lod.height + plots.lod.margin.top + plots.lod.margin.bottom)
            .attr('background-color', 'white')
        .append("g")
        .attr("transform", "translate(" + plots.lod.margin.left + "," + plots.lod.margin.top + ")")
    var yTitleDim = measureText(plots.lod.svg, "LOD Score", "y-axis-title");
    plots.lod.svg.append("text")
            .attr("y", 0 - plots.lod.margin.top - (yTitleDim.height/2))
            .attr("x", -(plots.lod.height/2) - (yTitleDim.width/2))
            .attr("transform", "rotate(-90)")
            .text("LOD Score")
            .attr("class", "y-axis-title");

    var xTitleDim = measureText(plots.lod.svg, "Chromosome", "x-axis-title");
    plots.lod.svg.append("text")
            .attr("y", plots.lod.height + plots.lod.margin.bottom)
            .attr("x", (plots.lod.width/2) - (xTitleDim.width/2))
            .text("Chromosome")
            .attr("class", "x-axis-title");
}




function initializePlotEffect(divId) {
    setPlotDefaults(plots.effect);
    plots.effect.id = divId;
    plots.effect.divWidth = parseInt($('#' + divId).attr('width'));
    plots.effect.divHeight = parseInt($('#' + divId).attr('height'));
    plots.effect.width = plots.effect.divWidth; //- plots.effect.margin.left - plots.effect.margin.right;
    plots.effect.height = plots.effect.divHeight - plots.effect.margin.top - plots.effect.margin.bottom;
    plots.effect.svg = d3.select('#' + divId)
        .append("svg")
        .attr('id', divId + 'SVG')
        .attr('width', plots.effect.width + plots.effect.margin.left + plots.effect.margin.right)
        .attr('height', plots.effect.height + plots.effect.margin.top + plots.effect.margin.bottom)
        .append("g")
        .attr("transform", "translate(" + plots.effect.margin.left + "," + plots.effect.margin.top + ")")

    var yTitleDim = measureText(plots.effect.svg, "Effect", "y-axis-title");
    plots.effect.svg.append("text")
            .attr("y", 0 - plots.effect.margin.top - (yTitleDim.height/2))
            .attr("x", -(plots.effect.height/2) - (yTitleDim.width/2))
            .attr("transform", "rotate(-90)")
            .text("Effect")
            .attr("class", "y-axis-title");

    var xTitleDim = measureText(plots.effect.svg, "Position (Mb)", "x-axis-title");
    plots.effect.svg.append("text")
            .attr("y", plots.effect.height + plots.effect.margin.bottom)
            .attr("x", (plots.effect.width/2) - (xTitleDim.width/2))
            .text("Position (Mb)")
            .attr("class", "x-axis-title");

    plots.effect.strainColors = {};

    // TODO: read strains and generate teh following
    // LOOK at how to style lines by css

    {% for strain in strains -%}
        plots.effect.strainColors["{{ strain['strain_id'] }}"] = {'color':"#F0F000",'name':"{{ strain['name'] }}"};
    {%- endfor %}


    /*
    plots.effect.strainColors["A"] = {'color':"#F0F000",'name':"A/J"};
    plots.effect.strainColors["B"] = {'color':"#808080",'name':"C57BL/6J"};
    plots.effect.strainColors["C"] = {'color':"#F08080",'name':"129S1/SvImJ"};
    plots.effect.strainColors["D"] = {'color':"#1010F0",'name':"NOD/ShiLtJ"};
    plots.effect.strainColors["E"] = {'color':"#00A0F0",'name':"NZO/H1LtJ"};
    plots.effect.strainColors["F"] = {'color':"#00A000",'name':"CAST/EiJ"};
    plots.effect.strainColors["G"] = {'color':"#F00000",'name':"PWK/PhJ"};
    plots.effect.strainColors["H"] = {'color':"#9000E0",'name':"WSB/EiJ"};
    */

    var width = plots.effect.width - 100;
    var legendTop = plots.effect.svg.append("g");
    legendTop.append("rect")
              .attr('class', 'legend')
              .style("fill", "#eeeeee")
              .style("stroke-width", 1)
              .style('stroke','black')
              .style('shape-rendering','crispEdges')
               .attr("x", width + 10)
               .attr("y", 0)
               .attr("width", plots.effect.width - width)
               .attr("height", (8*15)+5);

    var legend = legendTop.selectAll('g')
                     .data(function() {
                                var keys = [];
                                for(var k in plots.effect.strainColors) {
                                    keys.push(k);
                                }
                                return keys;
                          })
                    .enter()
                    .append('g');

    legend.append('rect')
            .attr('id', function (d, i) {
                return 'rect-strain-' + d;
            })
        .attr('x', width + 15)
        .attr('y', function (d, i) {
            return (i * 15) + 5;
        })
        .attr('width', 10)
        .attr('height', 10)
        .on("click", function(d) {
            var strainLine = plots.effect.svg.select("#strain-" + d);
            if (strainLine != null) {
                var opacity = strainLine.attr('opacity');
                //console.log('opacity=' + opacity);
                if (opacity == 0) {
                     strainLine.transition()
                                .attr("opacity", "1")
                                .style("stroke-width", "2");
                } else {
                     strainLine.transition()
                                .attr("opacity", "0")
                                .style("stroke-width", "10");

                }
            }

        })

    legend.append('text')
        .attr("class", "legend-text")
        .attr('x', width + 25)
        .attr('y', function (d, i) {
                        return ((i * 15) + 5) + 9;
    })
    .text(function (d) {
        return plots.effect.strainColors[d].name;
        });


}





/**
 * Zoom function
 * - fix the scales, translate, reposition circles and axis
 */
function zoomed() {
    var translate = plots.matrix.zoom.translate();
    var scale = plots.matrix.zoom.scale();

    tx = Math.min(0, Math.max(plots.matrix.width * (1 - scale), translate[0]));
    ty = Math.min(0, Math.max(plots.matrix.height * (1 - scale), translate[1]));

    plots.matrix.zoom.translate([tx, ty]);

    plots.matrix.svg.select(".x-axis").call(plots.matrix.xAxis);
    plots.matrix.svg.select(".y-axis").call(plots.matrix.yAxis);

    plots.matrix.chartBody.selectAll(".dot")
        .attr("class", "dot")
        .attr("cx", function (d) {
            return plots.matrix.x(chrMBPToTotalBP(d[_settings.MATRIX.marker_chrom], d[_settings.MATRIX.marker_location]));
        })
        .attr("cy", function (d) {
            return plots.matrix.y(chrMBPToTotalBP(d[_settings.MATRIX.feature_chrom], d[_settings.MATRIX.feature_location]));
        })
        .attr("r", function(d) {
            if ($('#checkboxShow').is(':checked')) {

                for (e in plots.matrix.found) {
                    if (d[_settings.MATRIX.feature_id].toUpperCase() === plots.matrix.found[e].toUpperCase()) {
                        return 2;
                    }
                }
                return 0;
            }  else {
                return 2;
            }
        })
        .style("opacity", function (d) {
            var s = parseFloat(d[_settings.MATRIX.lod_score]);
            if (s > 20) { return 1; }
            else { return s * 5 / 100; }
        });

    plots.matrix.svg.select(".x-grid")
        .call(plots.matrix.make_x_axis()
        .tickSize(-plots.matrix.height, 0, 0)
        .tickFormat(""));
    plots.matrix.svg.select(".y-grid")
        .call(plots.matrix.make_y_axis()
        .tickSize(-plots.matrix.width, 0, 0)
        .tickFormat(""));
}


function applyLODThreshold(lod_threshold) {
    //console.debug('lod_threshold=',lod_threshold);
    plots.matrix.chartBodyCircles.each(function() {

        if (lod_threshold >= $(this)[0].__data__[_settings.MATRIX.lod_score]) {
            $(this).hide();
        } else {
            $(this).show();
        }
    });
}


function plotFactExpViewData(jsonData) {
    var plotParams = {
        "title": "",
        "sampleCount": jsonData.samples,
        "xAxis": {
            "variables": jsonData.xvar,
            "min": null,
            "max": null
        },
        "yAxis": {
            "variables": jsonData.yvar,
            "min": null,
            "whiskers": {
                "units": "stderr",
                "dist": 1
            },
            "max": null
        }
    };
    plots.fact.jsobject = new FactExpPlot({'svg':d3.select("#fact-svg-chart")});
    plots.fact.jsobject.mouseOverPoint = function(a, b) {
        console.log(a, b);
        console.log($(b)[0].__data__);
    }
    plots.fact.jsobject.renderPlot(plotParams);

}

function getFactExpViewData(gene, factors) {
    if (gene == null) {
        return;
    }

    var json_url = '{{request.URL_BASE}}/factexp?gene=' + gene;

    if (typeof factors !== 'undefined') {
        json_url += ('&factors=' + factors.toString())
    }

    return;

    $.ajax({
        url: json_url,
        type: 'GET',
        //cache: true,
        dataType: 'json',
        //async: false, // don't go on if we can't load chromosome data
        beforeSend: function() {
            console.log('Attempting to download: ' + json_url);
        },
        complete: function() {
            console.log('Succesful download!');
        },
        success: function (jsonData) {
            console.log('Successfully downloaded ' + json_url);

            plotFactExpViewData(jsonData);





        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            console.error("Chromosome download error :" + XMLHttpRequest.responseText);
            console.error(errorThrown);
        }
    });

}

function buildHistory() {
    // cookies, everywhere cookie
    var gene_data = Cookies.getJSON("gene_data");

    console.log('checking history');
    if (!cookiesEnabled()) {
        $('#gene_history_div').html("<br><span class='text-danger'>History requires that cookies are enabled in your browser.</span>");
        return;
    }

    if (gene_data) {
        if (gene_data.length == 1) {
           $('#searchHistoryStatus').html("<p class='text-right text-muted'><em><small>Showing last gene viewed</small></em></p>");
        } else {
           $('#searchHistoryStatus').html("<p class='text-right text-muted'><em><small>Showing last " + gene_data.length.toLocaleString() + " genes viewed</small></em></p>");
        }

        var tbl = '<table id="historyTable" class="table-condensed">';
        tbl += '<thead><tr><th>Ensembl ID</th><th>Symbol</th><th>LOD Score</th></tr></thead>';
        tbl += '<tbody>';
        for (var i in gene_data) {
        //for (var i = gene_data.length; i-- > 0; ) {
            var gene = gene_data[i];
            console.log(i, gene);
            var row = '<tr>';
            console.log(gene);
            row += '<td><a href="#" id="plotMe" gene_id="' + gene['id'] + '" geneSymbol="' + gene['sym'] + '" ensId="' + gene['id'] + '">' + gene['id'] + '</a></td>';
            row += ('<td>' + gene['sym'] + '</td>');
            row += ('<td>' + Number(gene['lod']).toFixed(4) + '</td></tr>');
            row += '</tr>';
            tbl += row;
        }

        tbl += "</tbody>";
        tbl += "</table>";
        $('#gene_history_div').html(tbl);

        $("#historyTable").tablesorter({
            theme: "bootstrap",
            widthFixed: true,
            headerTemplate: '{content} {icon}', // new in v2.7. Needed to add the bootstrap icon!
            widgets: ["uitheme", "zebra"],
            widgetOptions: {
                zebra: ["even", "odd"]
            }
        });

        $("#historyTable a").click(function (e) {
            e.preventDefault();
            $("#geneInformation").html("<b>Gene</b>: " + "<a target='_newwin' href='http://www.informatics.jax.org/marker/" + $(this).attr('ensId') + "'>" + $(this).attr('geneSymbol') + '</a> (' + $(this).attr('ensId') + ')');
            downloadLodData($(this).attr('gene_id'));
            return false;
        });
    } else {
        $('#gene_history_div').html("<br><span class='text-danger'>No results found.</span>");
    }

}

$.extend($.tablesorter.themes.bootstrap, {
    // these classes are added to the table. To see other table classes available,
    // look here: http://twitter.github.com/bootstrap/base-css.html#tables
    table      : 'table table-bordered',
    //header     : 'bootstrap-header', // give the header a gradient background
    footerRow  : '',
    footerCells: '',
    icons      : '', // add "icon-white" to make them white; this icon class is added to the <i> in the header
    sortNone   : 'bootstrap-icon-unsorted',
    sortAsc    : 'icon-chevron-up glyphicon glyphicon-chevron-up',     // includes classes for Bootstrap v2 & v3
    sortDesc   : 'icon-chevron-down glyphicon glyphicon-chevron-down', // includes classes for Bootstrap v2 & v3
    active     : '', // applied when column is sorted
    hover      : '', // use custom css here - bootstrap class may not override it
    filterRow  : '', // filter row class
    even       : '', // odd row zebra striping
    odd        : ''  // even row zebra striping
  });


function getFactorOrder() {
      var selected = [];
        $('#factor-select option:selected').each(function() {
            selected.push([$(this).val(), $(this).attr('order')]);
        });

        selected.sort(function(a, b) {
            return a[1] - b[1];
        });

        var ordered = [];
        for (var i = 0; i < selected.length; i++) {
            ordered.push(selected[i][0]);
        }

    return ordered;

}

$().ready(function () {
    $("#searchResultsChoice").hide();

    loadChromosomeData(_settings.chromosomeDataFile);

    initializePlotMatrix('plotMatrix');
    initializePlotLod('plotLod');
    initializePlotEffect('plotEffect');


    plotPlotMatrix();

    $('#searchTerm').keypress(function(e) {
        var code = e.which ? e.which : e.keyCode;
        if (code === 13) {
            $(this).blur();
            $('#btnGo').focus().click();
        }
    });

    $('#btnGo').button().click(function() {
        findGene();
        return false;
    });

    $('#checkboxShow').on('change', function() {
        showFoundGenes();
    });

    $('#checkboxHighlight').on('change', function() {
        highlightFoundGenes();
    });

    // this hack is because the checkboxes werent displaying without clicking
    //$('#checkboxShow').checkbox('check');
    //$('#checkboxHighlight').checkbox('check');
    //$('#checkboxShow').checkbox('uncheck');
    //$('#checkboxHighlight').checkbox('uncheck');

    /*
    $('#downloadLODPlot').button().click(function() {
        generatePNG2('plotLodSVG');
        $('#downloadLODPlot').tooltip('hide');
        return false;
    });

    $('#downloadLODPlot').tooltip();

    $('#downloadEffectPlot').button().click(function() {
        generatePNG2('plotEffectSVG');
        $('#downloadEffectPlot').tooltip('hide');
        return false;
    });

    $('#downloadEffectPlot').tooltip();
    */

// List with handle


    /*, {
  handle: '.glyphicon-move',
  animation: 150
});
*/
    /*
       plots.fact.sortable = Sortable.create(document.getElementById('listWithHandle'),
               {
                   onEnd: function (evt) {
        console.log(evt.oldIndex);  // element's old index within parent
        console.log(evt.newIndex);  // element's new index within parent
    }
               });
               */

    var mySlider = new Slider("#lodSlider", {
        min: {{ g.WWW.LOD_THRESHOLD_MIN }},
        max: {{ g.WWW.LOD_THRESHOLD_MAX }},
        value: {{ lod_threshold }},
        tooltip: 'hide',
        tooltip_position: 'top',
        formatter: function (e) {
            return e.toFixed(1);

        }
    });

    mySlider.on("change", function(e) {
        _G.lod = e.newValue;
        $("#currentLodScore").html(_G.lod);
        applyLODThreshold(_G.lod);
        buildDataListTable(plots.matrix.data, _G.lod);
    });


        plots.fact.orderCount = 2;
        $('#factor-select').multiselect({
            onChange: function(option, checked) {
                if (checked) {
                    plots.fact.orderCount++;
                    $(option).attr('order', plots.fact.orderCount);
                }
                else {
                    $(option).attr('order', '');
                }
            },
            buttonWidth: '100%',
            /*
            buttonWidth: function() {
                return $("#factor-select-wrapper").width();
            },
            */
            buttonText: function(options) {
                if (options.length === 0) {
                    return 'None selected';
                }
                else {
                    var selected = [];
                    options.each(function() {
                        selected.push([$(this).text(), $(this).attr('order')]);
                    });

                    selected.sort(function(a, b) {
                        return a[1] - b[1];
                    });

                    var text = '';
                    for (var i = 0; i < selected.length; i++) {
                        text += ((i+1) + ": " + selected[i][0] + ', ');
                    }

                    return text.substr(0, text.length -2);
                }
            },
        });
/*
        $('#example-order-button').on('click', function() {
            var selected = [];
            $('#example-order option:selected').each(function() {
                selected.push([$(this).val(), $(this).data('order')]);
            });

            selected.sort(function(a, b) {
                return a[1] - b[1];
            });

            var text = '';
            for (var i = 0; i < selected.length; i++) {
                text += selected[i][0] + ', ';
            }
            text = text.substring(0, text.length - 2);

        });
    });
*/

    $("#btnFactPlot").on('click', function() {
        getFactExpViewData(_G.currentGene, getFactorOrder())
    });


    buildHistory();



});
</script>

{% endblock %}
